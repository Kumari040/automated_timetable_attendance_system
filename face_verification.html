<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            /* --- NEW: Classroom Background Image --- */
            background-image: url('https://images.unsplash.com/photo-1580582932707-520aed937b7b?q=80&w=2532&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        #video-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }
        #video {
            transform: scaleX(-1); /* Mirror the video feed */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 text-center">
        <h1 id="status-title" class="text-2xl font-bold text-gray-800">Step 2: Face Verification</h1>
        <p id="status-text" class="text-gray-600 text-sm mt-1">Loading models, please wait...</p>

        <div id="video-container" class="my-6 shadow-lg rounded-lg bg-gray-200">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay"></canvas>
        </div>

        <button id="capture-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
            Verify My Identity
        </button>
    </div>

    <!-- face-api.js library for face detection -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const captureBtn = document.getElementById('capture-btn');
        const statusTitle = document.getElementById('status-title');
        const statusText = document.getElementById('status-text');
        let detectionInterval;

        // --- Read Student ID from URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');

        if (studentId) {
            statusTitle.innerText = `Step 2: Verifying ${studentId}`;
        }


        // --- 1. Load Face Detection Models ---
        async function loadModels() {
            // The '/models' path is relative to where your HTML file is served.
            const MODEL_URL = './models';
            captureBtn.disabled = true;
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
                ]);
                console.log("Models loaded successfully");
                startVideoStream();
            } catch (error) {
                console.error("Error loading models:", error);
                statusText.innerText = "Error loading models. Please refresh.";
                statusText.classList.add('text-red-500');
            }
        }

        // --- 2. Start the Webcam ---
        function startVideoStream() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    statusText.innerText = "Position your face in the center.";
                    captureBtn.disabled = false;
                })
                .catch(err => {
                    console.error("Error accessing webcam:", err);
                    statusText.innerText = "Webcam access denied. Please enable camera permissions.";
                    statusText.classList.add('text-red-500');
                });
        }

        // --- 3. Detect Faces in Real-time ---
        video.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(video);
            overlay.getContext('2d').drawImage(canvas, 0, 0, canvas.width, canvas.height);
            
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(overlay, displaySize);

            detectionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                const ctx = overlay.getContext('2d');
                ctx.clearRect(0, 0, overlay.width, overlay.height);

                // Draw a box around the detected face
                if (resizedDetections.length > 0) {
                    faceapi.draw.drawDetections(overlay, resizedDetections);
                    statusText.innerText = "Face detected! Ready to verify.";
                    captureBtn.disabled = false;
                } else {
                    statusText.innerText = "No face detected. Please position yourself.";
                    captureBtn.disabled = true;
                }
            }, 100); // Run detection every 100ms
        });

        // --- 4. Handle Verification Button Click ---
        captureBtn.addEventListener('click', () => {
            clearInterval(detectionInterval); // Stop detecting
            video.pause();
            
            // In a real application, you would send the captured image/face data
            // to a server to compare against a database of registered students.
            statusTitle.innerText = "Verification Complete!";
            // Use the studentId in the final message
            statusText.innerHTML = `<span class="font-bold text-green-600">Attendance Confirmed for ${studentId || 'this student'}.</span> You can now close this window.`;
            captureBtn.style.display = 'none'; // Hide the button
        });

        // --- Start the process ---
        loadModels();
    </script>
</body>
</html>
